<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê¸€ì”¨ ì“°ê¸° ì—°ìŠµì¥</title>

  <style>
    /* ê¸€ì”¨ì²´ ë¡œë“œ: GangwonEduModu Light (L) */
    @font-face {
      font-family: 'GangwonEduModuL';
      font-weight: 300;
      font-style: normal;
      font-display: swap;
      src: url('https://cdn.jsdelivr.net/gh/fonts-archive/GangwonEduModu/GangwonEduModu-Light.woff2') format('woff2');
    }
    /* ê¸€ì”¨ì²´ ë¡œë“œ: GangwonEduModu Bold (B) */
    @font-face {
      font-family: 'GangwonEduModuB';
      font-weight: 700;
      font-style: normal;
      font-display: swap;
      src: url('https://cdn.jsdelivr.net/gh/fonts-archive/GangwonEduModu/GangwonEduModu-Bold.woff2') format('woff2');
    }
    /* ê¸€ì”¨ì²´ ë¡œë“œ: í•™êµì•ˆì‹¬ ë°›ì•„ì“°ê¸°ì²´ */
    @font-face {
      font-family: 'HakgyoansimBadasseugi';
      src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/2408-5@1.0/HakgyoansimBadasseugiTTF-L.woff2') format('woff2');
      font-weight: normal;
      font-style: normal;
    }

    /* í˜ì´ì§€ ì„¤ì •: A4 ì‚¬ì´ì¦ˆ ì„¸ë¡œ, ì—¬ë°± 1cm */
    @page { size: A4 portrait; margin: 1cm; }
    @media print {
      /* ì¸ì‡„ ì‹œ ì»¨íŠ¸ë¡¤ ì˜ì—­ ìˆ¨ê¸°ê¸° */
      #controls { display: none; }
      /* ì¸ì‡„ ì‹œ ì»¬ëŸ¬ ë³´ì • ë° ìƒë‹¨ ì—¬ë°± ì¶”ê°€ */
      body { -webkit-print-color-adjust: exact; margin-top: 20mm; }
      /* ì»¨í…Œì´ë„ˆëŠ” í•­ìƒ ë³´ì´ë„ë¡, í­ì„ ê°€ë“ ì±„ìš°ê¸° */
      #container { display: block !important; width: 100% !important; max-width: none !important; visibility: visible !important; }
      /* ë¸”ë¡ ë‚´ë¶€ì—ì„œ í˜ì´ì§€ ë¶„í•  ë°©ì§€ */
      .block { page-break-inside: avoid !important; break-inside: avoid !important; -webkit-page-break-inside: avoid; }
    }

    body { margin: 0; padding: 20px; font-family: 'Nanum Gothic', sans-serif; }
    #controls { margin-bottom: 16px; background: #f9f9f9; padding: 10px; border: 1px solid #ccc; }
    #controls label { margin-right: 12px; font-size: 16px; display: inline-block; margin-bottom: 6px; }
    #controls input, #controls select, #controls button { padding: 4px; font-size: 16px; }
    #controls button { margin-left: 8px; }
    .block { display: grid; gap: 0; margin-bottom: 12px; }
    .cell { display: flex; justify-content: center; align-items: center; width: 40px; height: 40px; border: 1px solid #000; font-size: 24px; overflow: hidden; position: relative; box-sizing: border-box; }
    .cell::before { content: ""; position: absolute; top: 50%; left: 0; width: 100%; height: 0; border-top: 1px dashed rgba(0,0,0,0.3); transform: translateY(-0.5px); }
    .cell::after { content: ""; position: absolute; top: 0; left: 50%; width: 0; height: 100%; border-left: 1px dashed rgba(0,0,0,0.3); transform: translateX(-0.5px); }
    .guide { color: #000; }
    .ghost { color: #ccc; }
    #studentNameDisplay { display: flex; justify-content: flex-end; font-size: 20px; margin-bottom: 8px; padding-right: 20px; }
    #studentNameDisplay span { border-bottom: 1px solid #000; padding-bottom: 2px; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
  <div id="controls">
    <div style="margin-bottom:1px;">
      <label>ì—°ìŠµí•  ê¸€ì: <input id="inputText" type="text" placeholder="ì§ì ‘ ì…ë ¥í•  ê¸€ì..." style="width:300px;"></label>
      <label style="margin-left:24px;"><button id="randomShortBtn" type="button">ì§§ì€ ê¸€ ëœë¤</button></label>
      <label style="margin-left:24px;">ê¸´ ê¸€ ì„ íƒ: <select id="exampleSelect"><option value="">-- ê¸´ ê¸€ ì„ íƒ --</option></select></label>
      <label style="margin-left:24px;">ì´ë¦„: <input id="studentName" type="text" placeholder="ì´ë¦„ ì…ë ¥..." style="width:120px;"></label>
      <button id="generate">ë§Œë“¤ê¸°</button>
      <button id="reset">ì´ˆê¸°í™”</button>
    </div>
    <label>ê¸€ì”¨ì²´: <select id="fontSelect">
      <option value="GangwonEduModuL" selected>ê°•ì›êµìœ¡ëª¨ë‘ì²´ L</option>
      <option value="GangwonEduModuB">ê°•ì›êµìœ¡ëª¨ë‘ì²´ B</option>
      <option value="HakgyoansimBadasseugi">í•™êµì•ˆì‹¬ ë°›ì•„ì“°ê¸°ì²´</option>
      <option value="Nanum Gothic">ë‚˜ëˆ”ê³ ë”•</option>
      <option value="Nanum Myeongjo">ë‚˜ëˆ”ëª…ì¡°</option>
      <option value="Nanum Pen Script">ë‚˜ëˆ”íœ ìŠ¤í¬ë¦½íŠ¸</option>
      <option value="Noto Sans KR">Noto Sans KR</option>
      <option value="Noto Serif KR">Noto Serif KR</option>
      <option value="Roboto">Roboto</option>
    </select></label>
    <label style="margin-left:24px;">í•™ë…„: <select id="gradeSelect">
      <option value="1">1í•™ë…„</option>
      <option value="2">2í•™ë…„</option>
      <option value="3">3í•™ë…„</option>
      <option value="4">4í•™ë…„</option>
      <option value="5">5í•™ë…„</option>
      <option value="6">6í•™ë…„</option>
    </select></label>
    <label style="margin-left:24px;">í¬ê¸°(pt): <input id="sizeInput" type="number" value="40" min="12" max="72"></label>
    <label style="margin-left:24px;">ì—°ìŠµì¤„ ìˆ˜: <select id="blankCount">
      <option value="0">0ì¤„</option>
      <option value="1">1ì¤„</option>
      <option value="2" selected>2ì¤„</option>
      <option value="3">3ì¤„</option>
      <option value="4">4ì¤„</option>
    </select></label>
    <label style="margin-left:24px;"><input type="checkbox" id="showGhost"> ë”°ë¼ì“°ê¸° ì¶”ê°€</label>
    <label style="margin-left:24px;"><input type="radio" name="printOrientation" id="portraitMode" value="portrait" checked> ì„¸ë¡œ</label>
    <label style="margin-left:16px;"><input type="radio" name="printOrientation" id="landscapeMode" value="landscape"> ê°€ë¡œ</label>
    <button id="print">ì¸ì‡„</button>
    <button id="savePdf">PDF ì €ì¥</button><label style="margin-left:80px;">
    <button id="openManual" type="button">ì„¤ëª…ì„œ</button>
  </div>
  <div id="container"><div id="studentNameDisplay"></div></div>
<script>

  document.addEventListener('DOMContentLoaded', () => {
    const mappings = [
      { id: 'gradeSelect', type: 'value' },
      { id: 'fontSelect',  type: 'value' },
      { id: 'sizeInput',   type: 'value' },
      { id: 'blankCount',  type: 'value' },
      { id: 'showGhost',   type: 'checked' },
      { id: 'portraitMode',type: 'checked', storageKey: 'printOrientation' },
      { id: 'landscapeMode', type: 'checked', storageKey: 'printOrientation' }
    ];

    mappings.forEach(({id, type, storageKey}) => {
      const el = document.getElementById(id);
      const key = storageKey || id;
      const saved = localStorage.getItem(key);
      if (saved != null) {
        if (type === 'checked') {
          // ë¼ë””ì˜¤/ì²´í¬ë°•ìŠ¤
          el.checked = (saved === el.value) || (saved === 'true' && el.type === 'checkbox');
        } else {
          el.value = saved;
        }
      }
    });

    // orientation ìŠ¤íƒ€ì¼ ì¦‰ì‹œ ë°˜ì˜
    if (document.getElementById('landscapeMode').checked) {
      document.querySelector('input[name=printOrientation][value=landscape]').click();
    }
  });

  // 2) ì‚¬ìš©ìê°€ ì„¤ì •ì„ ë°”ê¿€ ë•Œë§ˆë‹¤ ì €ì¥í•˜ê¸°
  function bindSave(id, type, storageKey) {
    const el = document.getElementById(id);
    const key = storageKey || id;
    const ev = (type === 'value') ? 'input' : 'change';
    el.addEventListener(ev, () => {
      const val = (type === 'checked') ? el.checked ? el.value : null : el.value;
      if (val != null) localStorage.setItem(key, val);
      else localStorage.removeItem(key);
    });
  }

  bindSave('gradeSelect', 'value');
  bindSave('fontSelect',  'value');
  bindSave('sizeInput',   'value');
  bindSave('blankCount',  'value');
  bindSave('showGhost',   'checked');
  // ë¼ë””ì˜¤ ë²„íŠ¼ ë‘ ê°œ ì¤‘ í•˜ë‚˜ë§Œ key 'printOrientation' ë¡œ ì €ì¥
  bindSave('portraitMode', 'checked', 'printOrientation');
  bindSave('landscapeMode','checked', 'printOrientation');

  // DOM ìš”ì†Œ ì°¸ì¡°
  const input = document.getElementById('inputText');
  const fontSel = document.getElementById('fontSelect');
  const gradeSel = document.getElementById('gradeSelect');
  const sizeIn = document.getElementById('sizeInput');
  const blankSel = document.getElementById('blankCount');
  const ghostChk = document.getElementById('showGhost');
  const exampleSelect = document.getElementById('exampleSelect');
  const generateBtn = document.getElementById('generate');
  const resetBtn = document.getElementById('reset');
  const printBtn = document.getElementById('print');
  const savePdfBtn = document.getElementById('savePdf');
  const portraitRadio = document.getElementById('portraitMode');
  const landscapeRadio = document.getElementById('landscapeMode');
  const cont = document.getElementById('container');
  const nameDisplay = document.getElementById('studentNameDisplay');
  let examples = {};
  let currentOrientation = 'portrait';
  let currentText = '';
  let shortSentences = [];

  // ì˜ˆë¬¸ ë¡œë“œ
  fetch('/examples.json').then(res => res.json()).then(data => {
    examples = data;
    Object.keys(data).forEach(title => {
      const opt = document.createElement('option');
      opt.value = title;
      opt.textContent = title;
      exampleSelect.appendChild(opt);
    });
  });
  // ì§§ì€ ë¬¸ì¥ ë¡œë“œ
  fetch('/short_sentences.txt')
    .then(res => res.text())
    .then(text => { shortSentences = text.split(/\r?\n/).map(line => line.trim()).filter(line => line); })
    .catch(err => console.error('short_sentences.txt ë¡œë“œ ì‹¤íŒ¨', err));

  // Enter í‚¤ ì´ë²¤íŠ¸
  input.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); generateBtn.click(); } });
  document.getElementById('studentName').addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); if (currentText) render(currentText); } });

  // í•™ë…„ë³„ ê¸°ë³¸ í¬ê¸°
  const gradeSize = {1:40,2:38,3:36,4:34,5:32,6:30};
  gradeSel.addEventListener('change', () => { const g = parseInt(gradeSel.value,10); if (gradeSize[g]) sizeIn.value = gradeSize[g]; if (currentText) render(currentText); });
  fontSel.addEventListener('change', () => { if (currentText) render(currentText); });
  sizeIn.addEventListener('input', () => { if (currentText) render(currentText); });
  blankSel.addEventListener('change', () => { if (currentText) render(currentText); });
  ghostChk.addEventListener('change', () => { if (currentText) render(currentText); });
  portraitRadio.addEventListener('change', () => { updatePrintOrientation(); if (currentText) render(currentText); });
  landscapeRadio.addEventListener('change', () => { updatePrintOrientation(); if (currentText) render(currentText); });

  // ìƒì„± ë° ì´ˆê¸°í™”
  generateBtn.addEventListener('click', () => {
    const t = input.value || examples[exampleSelect.value] || '';
    if (!t) { alert('ê¸€ìë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ì˜ˆë¬¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”!'); return; }
    currentText = t; render(t);
  });
  resetBtn.addEventListener('click', () => { input.value = ''; exampleSelect.value = ''; cont.innerHTML = '<div id="studentNameDisplay"></div>'; currentText = ''; });

  // ì¸ì‡„ ë° PDF ì €ì¥
  printBtn.addEventListener('click', () => { if (!currentText) { alert('ë¨¼ì € ê¸€ìë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”!'); return; } render(currentText); setTimeout(() => window.print(), 100); });
  savePdfBtn.addEventListener('click', () => {
    const element = document.getElementById('container');
    const studentName = document.getElementById('studentName').value.trim() || 'ì—°ìŠµì§€';
    const today = new Date();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const date = String(today.getDate()).padStart(2, '0');
    const dateString = `${month}${date}`;
    const fileName = `${dateString}_${studentName}.pdf`;
    const opt = { margin: [10,10,10,10], filename: fileName, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'mm',format:'a4',orientation:currentOrientation},pagebreak:{avoid:['.block']} };
    html2pdf().set(opt).from(element).save();
  });

  // ëœë¤ ë¬¸ì¥ ì¶”ê°€
  document.getElementById('randomShortBtn').addEventListener('click', () => {
    if (!shortSentences.length) { alert('ì•„ì§ ë¬¸ì¥ ëª©ë¡ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'); return; }
    const rand = shortSentences[Math.floor(Math.random()*shortSentences.length)];
    currentText = currentText ? currentText + rand : rand;
    render(currentText);
  });

  // ë Œë” í•¨ìˆ˜: ê·¸ë¦¬ë“œ ìƒì„±
  function render(text) {
    const font = fontSel.value;
    const size = parseInt(sizeIn.value,10);
    const showGhost = ghostChk.checked;
    const baseBlank = parseInt(blankSel.value,10);
    const cellSize = Math.ceil(size * 1.4);
    const pageWidth = currentOrientation==='landscape'?950:700;
    cont.style.width = '100%';
      let colCount = Math.floor(pageWidth / cellSize);
  // ê°€ë¡œ ëª¨ë“œë©´ í•œ ì¹¸ ì¶”ê°€
 	 if (currentOrientation === 'landscape') {
  	  colCount += 1;
 	 }
    const letters = text.split('');
    const lines=[];
    for (let i=0;i<letters.length;i+=colCount) {
      let chunk = letters.slice(i,i+colCount);
      while(chunk.length<colCount) chunk.push('');
      lines.push(chunk);
    }
    const studentName = document.getElementById('studentName').value.trim();
    const today=new Date();
    const month=String(today.getMonth()+1).padStart(2,'0');
    const date=String(today.getDate()).padStart(2,'0');
    const dateString=`${month}${date}`;
    nameDisplay.innerHTML = studentName?`<span>${dateString}_${studentName}</span>`:'';
    cont.innerHTML=''; cont.appendChild(nameDisplay);
    // ğŸ”„ ì „ì²´ ë¬¸ìì—´ì„ colCountì”© ë‚˜ëˆˆ ê° ì¤„ì„ ë Œë”ë§
    lines.forEach((chunk, lineNo) => {
      const block = document.createElement('div');
      block.classList.add('block');

      const actualBlank = showGhost ? Math.max(baseBlank - 1, 0) : baseBlank;
      const totalRows = 1 + (showGhost ? 1 : 0) + actualBlank;

      block.style.display = 'grid';
      block.style.gridTemplateColumns = `repeat(${colCount}, ${cellSize}px)`;
      block.style.gridTemplateRows = `repeat(${totalRows}, ${cellSize}px)`;

      // ì´ ì¤„(chunk)ì˜ ì‹œì‘ ì¸ë±ìŠ¤(ë¬¸ì¥ ì „ì²´ ê¸°ì¤€)
      const startIdx = lineNo * colCount;

      const isQuote = c => ['â€œ', 'â€', '"', 'â€˜', 'â€™', "'"].includes(c);
      const quoteIndices = letters
            .map((c, idx) => (isQuote(c) ? idx : -1))
            .filter(idx => idx >= 0);


      // ê³µí†µ ìŠ¤íƒ€ì¼ëŸ¬: ë§ˆì¹¨í‘œ/ë”°ì˜´í‘œ ì •ë ¬ ê·œì¹™
      function styleChar(cell, ch, globalIdx) {
        cell.style.fontFamily = `${font}, sans-serif`;
        cell.style.fontSize = `${size}px`;

        if (/[.,]/.test(ch)) {
          // ë§ˆì¹¨í‘œÂ·ì‰¼í‘œëŠ” í•­ìƒ ì™¼ìª½ ì •ë ¬
          cell.style.justifyContent = 'flex-start';
          cell.style.paddingLeft = '6px';
          return;
        }

        if (isQuote(ch)) {
              // í˜„ì¬ ë”°ì˜´í‘œê°€ ì „ì²´ ë”°ì˜´í‘œ ì¤‘ ëª‡ ë²ˆì§¸ì¸ì§€ ê³„ì‚°
              const order = quoteIndices.indexOf(globalIdx);

              if (order % 2 === 0) {
                // ì²« ë²ˆì§¸(0), ì„¸ ë²ˆì§¸(2), ... ë”°ì˜´í‘œ â†’ ì˜¤ë¥¸ìª½ ì •ë ¬
                cell.style.justifyContent = 'flex-end';
                cell.style.paddingRight = '6px';
            } else {
                // ë‘ ë²ˆì§¸(1), ë„¤ ë²ˆì§¸(3), ... ë”°ì˜´í‘œ â†’ ì™¼ìª½ ì •ë ¬
                cell.style.justifyContent = 'flex-start';
                cell.style.paddingLeft = '6px';
            }
          }
      }

      // ê°€ì´ë“œ ì…€
      chunk.forEach((ch, idx) => {
        const cell = document.createElement('div');
        cell.className = 'cell guide';
        cell.style.width = cell.style.height = `${cellSize}px`;
        cell.style.lineHeight = `${cellSize}px`;
        cell.textContent = ch;

        if (ch.trim()) {
          const globalIdx = startIdx + idx; // ì „ì²´ ë¬¸ìì—´ ê¸°ì¤€ ìœ„ì¹˜
          styleChar(cell, ch, globalIdx);
        }
        block.appendChild(cell);
      });

      // ë”°ë¼ì“°ê¸°(ghost) ì…€
      if (showGhost) {
        chunk.forEach((ch, idx) => {
          const cell = document.createElement('div');
          cell.className = 'cell ghost';
          cell.style.width = cell.style.height = `${cellSize}px`;
          cell.style.lineHeight = `${cellSize}px`;
          cell.textContent = ch;

          if (ch.trim()) {
            const globalIdx = startIdx + idx;
            styleChar(cell, ch, globalIdx);
          }
          block.appendChild(cell);
        });
      }

      // ë¹ˆ ë¸”ë­í¬ ì¤„
      for (let r = 0; r < actualBlank; r++) {
        chunk.forEach(() => {
          const cell = document.createElement('div');
          cell.className = 'cell';
          cell.style.width = cell.style.height = `${cellSize}px`;
          cell.style.lineHeight = `${cellSize}px`;
          block.appendChild(cell);
        });
      }

      // í•œ ì¤„ ì™„ë£Œ
      cont.appendChild(block);
    });
  }
  // ì¸ì‡„ ë°©í–¥ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
  const printStyle=document.createElement('style'); document.head.appendChild(printStyle);
  function updatePrintOrientation(){
    const orientation=portraitRadio.checked?'portrait':'landscape';
    currentOrientation=orientation;
    printStyle.innerHTML=`@page { size: A4 ${orientation}; margin: 1cm; }`;
  }
  updatePrintOrientation();
  window.addEventListener('beforeprint',()=>{ if(currentText) render(currentText); });

const manualBtn = document.getElementById('openManual');
manualBtn.addEventListener('click', () => {
  // manual.html ë˜ëŠ” manual.pdf íŒŒì¼ì„ public/ í´ë”ì— ë‘ì„¸ìš”.
  window.open(
    'manual.html',      // ë˜ëŠ” 'manual.pdf'
    '_blank',           // ìƒˆ íƒ­/ì°½
    'width=900,height=600,scrollbars=yes'
  );
});
</script>
</body>
</html>